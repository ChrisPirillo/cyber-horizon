<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1CQ4D3VQ3L"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-1CQ4D3VQ3L');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- SEO & Metadata -->
    <title>Cyber Horizon</title>
    <meta name="description" content="A procedural synthwave horizon generator. Create retro-futuristic 80s landscapes with neon grids, sunsets, and cityscapes in your browser.">
    <meta name="keywords" content="Cyber Horizon, synthwave generator, WebGL, 80s aesthetic, retro visualizer, neon grid, procedural landscape, cyberpunk">
    <meta name="author" content="Chris Pirillo">
    <link rel="canonical" href="https://pirillo.com/arcade/cyber-horizon.html">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pirillo.com/arcade/cyber-horizon.html">
    <meta property="og:title" content="Cyber Horizon">
    <meta property="og:description" content="A procedural synthwave horizon generator running in WebGL. Experience the retro-future.">
    <meta property="og:image" content="https://pirillo.com/arcade/images/cyber-horizon.png">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@ChrisPirillo">
    <meta name="twitter:creator" content="@ChrisPirillo">
    <meta name="twitter:title" content="Cyber Horizon">
    <meta name="twitter:description" content="A procedural synthwave horizon generator running in WebGL.">
    <meta name="twitter:image" content="https://pirillo.com/arcade/images/cyber-horizon.png">

    <!-- Performance: Preconnect & Font Loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <!-- Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Cyber Horizon",
      "url": "https://pirillo.com/arcade/cyber-horizon.html",
      "description": "A procedural synthwave horizon generator running in WebGL.",
      "genre": "Simulation",
      "browserRequirements": "Requires WebGL2 support",
      "author": {
        "@type": "Person",
        "name": "Chris Pirillo",
        "url": "https://chris.pirillo.com/"
      },
      "image": "https://pirillo.com/arcade/images/cyber-horizon.png",
      "applicationCategory": "MultimediaApplication"
    }
    </script>

    <style>
        /* CSS Variables & Reset */
        :root {
            --bg-glass: rgba(5, 5, 10, 0.95);
            --border-glass: rgba(255, 255, 255, 0.1);
            --accent: #00f0ff;
            --accent-glow: rgba(0, 240, 255, 0.4);
            --text-main: #ffffff;
            --text-dim: #8899a6;
            --panel-width: 360px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            width: 100vw;
            height: 100vh;
        }

        /* Canvas & Overlay */
        canvas {
            display: block;
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
        }

        #fader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 2;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }

        /* UI Layer */
        #ui-layer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
        }

        /* Menu Button */
        #menu-btn {
            position: absolute;
            top: 24px;
            left: 24px;
            width: 48px;
            height: 48px;
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--border-glass);
            border-radius: 12px;
            cursor: pointer;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 6px;
            backdrop-filter: blur(10px);
            z-index: 50;
            transition: all 0.2s;
        }
        #menu-btn:hover { 
            border-color: var(--accent); 
            box-shadow: 0 0 15px var(--accent-glow);
        }
        #menu-btn span {
            width: 24px; height: 2px; background: white; border-radius: 2px;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #menu-btn.open span:nth-child(1) { transform: translateY(8px) rotate(45deg); }
        #menu-btn.open span:nth-child(2) { opacity: 0; }
        #menu-btn.open span:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }

        /* Settings Panel */
        #settings-panel {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: var(--panel-width);
            background: var(--bg-glass);
            backdrop-filter: blur(40px);
            border-right: 1px solid var(--border-glass);
            transform: translateX(-100%);
            /* Added box-shadow to transition list so it fades in/out */
            transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1), box-shadow 0.35s ease;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            /* Shadow removed from default state to prevent bleeding */
            box-shadow: none; 
        }
        
        #settings-panel.active { 
            transform: translateX(0); 
            box-shadow: 20px 0 50px rgba(0,0,0,0.8);
        }

        @media (max-width: 768px) {
            #settings-panel {
                width: 100%;
                border-right: none;
                border-top: 1px solid var(--border-glass);
                height: 75%; 
                bottom: 0;
                top: auto;
                transform: translateY(110%);
                border-radius: 20px 20px 0 0;
            }
            #settings-panel.active { transform: translateY(0); }
        }

        .panel-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-glass);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, transparent 100%);
        }
        .panel-header h2 { 
            margin: 0; 
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.5rem; 
            font-weight: 700; 
            letter-spacing: 2px;
            text-transform: uppercase;
            background: linear-gradient(90deg, #fff, #888);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: var(--text-dim);
            font-size: 1.1rem;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .header-icon:hover {
            color: var(--accent);
            background: rgba(255,255,255,0.05);
            border-color: var(--border-glass);
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        /* Custom Scrollbar */
        .panel-content::-webkit-scrollbar { width: 4px; }
        .panel-content::-webkit-scrollbar-track { background: transparent; }
        .panel-content::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        .panel-content::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* Section Styling */
        .section-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 24px 0 12px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--border-glass), transparent);
        }
        .section-title:first-child { margin-top: 0; }

        /* Color Grid */
        .color-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }
        .color-item label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-bottom: 6px;
            text-transform: uppercase;
        }
        input[type="color"] {
            -webkit-appearance: none;
            border: 1px solid var(--border-glass);
            width: 100%;
            height: 40px;
            border-radius: 6px;
            cursor: pointer;
            padding: 0;
            background: rgba(255,255,255,0.05);
            transition: border-color 0.2s;
        }
        input[type="color"]:hover { border-color: var(--text-dim); }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 4px; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 3px; }

        /* Controls */
        .control-group { margin-bottom: 20px; }
        .control-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: var(--text-dim);
        }
        .val-display { color: var(--accent); font-family: 'Rajdhani', monospace; font-weight: bold; }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px; height: 18px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
            transition: transform 0.1s, background-color 0.2s;
            margin-top: -6px; /* center thumb */
        }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: transparent;
            border-radius: 3px;
        }
        input[type="range"]:hover::-webkit-slider-thumb { transform: scale(1.1); background: var(--accent); }

        /* Toggles */
        .toggles-container {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }
        .toggle-btn {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-glass);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-dim);
        }
        .toggle-btn.active {
            background: rgba(0, 240, 255, 0.15);
            border-color: var(--accent);
            color: #fff;
            text-shadow: 0 0 8px var(--accent-glow);
        }
        .toggle-btn:hover { background: rgba(255,255,255,0.1); }

        /* Actions */
        .actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 30px;
            border-top: 1px solid var(--border-glass);
            padding-top: 20px;
        }
        
        .btn {
            padding: 14px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-glass);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            text-align: center;
            font-size: 0.9rem;
        }
        .btn:hover { 
            background: rgba(255,255,255,0.1); 
            border-color: var(--text-main); 
        }
        .btn-primary { 
            grid-column: span 2;
            background: var(--accent); 
            border-color: var(--accent);
            color: #000;
        }
        .btn-primary:hover { 
            background: #fff; 
            border-color: #fff;
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .auto-row {
            grid-column: span 2;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        /* Checkbox Switch for Auto */
        .switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333;
            transition: .3s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(16px); }

        /* Modal */
        #info-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        #info-modal.visible { opacity: 1; pointer-events: auto; }
        .modal-card {
            background: #0f0f14;
            padding: 40px;
            border-radius: 16px;
            border: 1px solid var(--border-glass);
            max-width: 500px; /* Increased width to prevent squashing */
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal-card h3 { 
            margin-top: 0; 
            color: var(--accent); 
            font-family: 'Rajdhani', sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .modal-card p { margin-bottom: 20px; line-height: 1.6; color: var(--text-dim); }
        .modal-card a {
            display: block;
            margin: 8px 0;
            color: white;
            text-decoration: none;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            transition: background 0.2s;
        }
        .modal-card a:hover { background: rgba(255,255,255,0.1); }
    </style>
</head>
<body>

    <canvas id="c"></canvas>
    <div id="fader"></div>

    <div id="ui-layer">
        <button id="menu-btn" aria-label="Open Settings">
            <span></span><span></span><span></span>
        </button>

        <aside id="settings-panel" aria-label="Settings Panel">
            <header class="panel-header">
                <h2>Cyber Horizon</h2>
                <div class="header-controls">
                    <div class="header-icon" id="info-btn" role="button" aria-label="About">?</div>
                    <div class="header-icon" id="close-btn" role="button" aria-label="Close Settings">âœ•</div>
                </div>
            </header>
            <div class="panel-content">
                
                <div class="section-title" role="heading" aria-level="3">Palette</div>
                <div class="color-grid">
                    <div class="color-item">
                        <label for="sky-color">Sky</label>
                        <input type="color" id="sky-color" value="#661a1a">
                    </div>
                    <div class="color-item">
                        <label for="horizon-color">Horizon</label>
                        <input type="color" id="horizon-color" value="#ff00ff">
                    </div>
                    <div class="color-item">
                        <label for="grid-color">Grid</label>
                        <input type="color" id="grid-color" value="#1a1c2e">
                    </div>
                    <div class="color-item">
                        <label for="sun-color">Sun</label>
                        <input type="color" id="sun-color" value="#ffcc66">
                    </div>
                </div>

                <div class="section-title" role="heading" aria-level="3">Environment</div>
                <div class="toggles-container">
                    <button class="toggle-btn" id="btn-city">City</button>
                    <button class="toggle-btn" id="btn-wave">Ripples</button>
                    <button class="toggle-btn" id="btn-stars">Stars</button>
                </div>

                <div class="section-title" role="heading" aria-level="3">Terrain & Grid</div>
                <div class="control-group">
                    <div class="control-header"><span>Speed</span> <span class="val-display" id="speed-val"></span></div>
                    <input type="range" id="speed-range" min="1" max="13" step="0.5" aria-label="Speed">
                </div>
                <div class="control-group">
                    <div class="control-header"><span>Terrain Height</span> <span class="val-display" id="height-val"></span></div>
                    <input type="range" id="height-range" min="0.5" max="4.0" step="0.1" aria-label="Terrain Height">
                </div>
                <div class="control-group">
                    <div class="control-header"><span>Grid Scale</span> <span class="val-display" id="scale-val"></span></div>
                    <input type="range" id="scale-range" min="0.5" max="1.0" step="0.05" aria-label="Grid Scale">
                </div>
                <div class="control-group">
                    <div class="control-header"><span>Line Width</span> <span class="val-display" id="line-width-val"></span></div>
                    <input type="range" id="line-width-range" min="0.01" max="0.2" step="0.01" aria-label="Line Width">
                </div>
                <div class="control-group">
                    <div class="control-header"><span>Reflection</span> <span class="val-display" id="reflect-val"></span></div>
                    <input type="range" id="reflect-range" min="0.0" max="1.0" step="0.05" aria-label="Reflection">
                </div>

                <div class="section-title" role="heading" aria-level="3">Atmosphere</div>
                <div class="control-group">
                    <div class="control-header"><span>Beam Length</span> <span class="val-display" id="ray-len-val"></span></div>
                    <input type="range" id="ray-len-range" min="0.1" max="1.0" step="0.05" aria-label="Beam Length">
                </div>
                <div class="control-group">
                    <div class="control-header"><span>Beam Strength</span> <span class="val-display" id="ray-str-val"></span></div>
                    <input type="range" id="ray-str-range" min="0.0" max="1.0" step="0.05" aria-label="Beam Strength">
                </div>
                <div class="control-group">
                    <div class="control-header"><span>Star Density</span> <span class="val-display" id="stars-val"></span></div>
                    <input type="range" id="stars-range" min="0.1" max="1.0" step="0.1" aria-label="Star Density">
                </div>

                <div class="actions-grid">
                    <button class="btn btn-primary" id="random-btn">Randomize</button>
                    <button class="btn" id="shot-btn">4K Shot</button>
                    <button class="btn" id="reset-btn">Reset</button>
                    <button class="btn" id="export-btn">Export</button>
                    <button class="btn" id="import-btn-trigger">Import</button>
                    <input type="file" id="import-file" style="display:none" accept=".json" aria-label="Import Settings">
                    
                    <div class="auto-row">
                        <span>Auto-Randomize (10s)</span>
                        <label class="switch"><input type="checkbox" id="auto-check" aria-label="Auto Randomize"><span class="slider"></span></label>
                    </div>
                </div>

            </div>
        </aside>
    </div>

    <div id="info-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-card">
            <h3 id="modal-title">CYBER HORIZON</h3>
            <p>
                A procedural synthwave horizon generator.<br>
                Double-tap canvas or click empty space to randomize.
            </p>
            <p style="font-size: 0.8rem; color: #666;">Reference formula by stduhpf</p>
            <a href="https://pirillo.com/arcade/" target="_blank" rel="noopener noreferrer">More Apps</a>
            <a href="https://chris.pirillo.com/" target="_blank" rel="noopener noreferrer">Follow Chris</a>
            <a href="https://ctrlaltcreate.live/" target="_blank" rel="noopener noreferrer">Learn More</a>
            <button class="btn" id="modal-close" style="width:100%; margin-top:15px;">CLOSE (ESC)</button>
        </div>
    </div>

<script>
/** * CORE STATE & CONFIGURATION 
 */
const defaults = {
    city: false,
    citySeed: 166.0,
    wave: true,
    stars: true,
    starDensity: 0.5,
    speed: 10.0,
    height: 2.0, 
    gridScale: 1.0,
    lineWidth: 0.05,
    reflection: 0.6,
    rayLength: 0.6,
    rayStrength: 0.5,
    sunY: 0.125,
    soundTex: true,
    skyColor: "#661AB3",
    horizonColor: "#bd20a4",
    gridColor: "#1A1C2E",
    sunColor: "#FFCC66"
};

let state = { ...defaults };

// Runtime globals
let gl, program;
let startTime = Date.now();
let canvas = document.getElementById('c');
let fader = document.getElementById('fader');
let mouse = { x: 0, y: 0, drag: false };
let camera = { x: 0, y: 0 }; 
let noiseTexture;
let autoTimer = null;
let isMenuOpen = false;
let wasMenuOpenOnDown = false; 

function hexToRGB(hex) {
    const r = parseInt(hex.substr(1,2), 16) / 255;
    const g = parseInt(hex.substr(3,2), 16) / 255;
    const b = parseInt(hex.substr(5,2), 16) / 255;
    return [r, g, b];
}

function hslToHex(h, s, l) {
    l /= 100;
    const a = s * Math.min(l, 1 - l) / 100;
    const f = n => {
        const k = (n + h / 30) % 12;
        const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
        return Math.round(255 * color).toString(16).padStart(2, '0');
    };
    return `#${f(0)}${f(8)}${f(4)}`;
}

/** SHADER SOURCE GENERATOR */
const vsSource = `#version 300 es
in vec4 position;
void main() { gl_Position = position; }`;

function getFsSource() {
    let header = `#version 300 es
    precision highp float;`;
    
    let defines = `
    #define AA 1.
    #define speed_uniform
    ${state.city ? '#define city' : ''}
    ${state.wave ? '#define wave_thing' : ''}
    ${state.stars ? '#define stars_on' : ''}
    ${!state.soundTex ? '#define disable_sound_texture_sampling' : ''}
    `;

    const core = `
    uniform vec3 iResolution;
    uniform float iTime;
    uniform float iTimeDelta;
    uniform sampler2D iChannel0;
    uniform float uSpeed;
    uniform vec2 uCamPos;
    uniform float uHeight;
    uniform float uGridScale;
    uniform float uLineWidth;
    uniform float uReflection;
    uniform float uRayLength;
    uniform float uRayStrength;
    uniform float uSunY;
    uniform float uCitySeed;
    uniform float uStarDensity;

    uniform vec3 uSkyColor;
    uniform vec3 uHorizonColor;
    uniform vec3 uGridColor;
    uniform vec3 uSunColor;

    out vec4 fragColor;

    #ifdef speed_uniform
       #define speed uSpeed
    #else
       #define speed 10.
    #endif

    #define audio_vibration_amplitude 0.

    float jTime;

    #ifdef disable_sound_texture_sampling
    #define textureMirror(a, b) vec4(0)
    #else
    vec4 textureMirror(sampler2D tex, vec2 c){
        vec2 cf = fract(c);
        return texture(tex,mix(cf,1.-cf,mod(floor(c),2.)));
    }
    #endif

    float amp(vec2 p){ return smoothstep(1.,8.,abs(p.x)); }

    float pow512(float a){ a*=a; a*=a; a*=a; a*=a; a*=a; a*=a; a*=a; a*=a; return a*a; }
    float pow1d5(float a){ return a*sqrt(a); }
    float hash21(vec2 co){ return fract(sin(dot(co.xy,vec2(1.9898,7.233)))*45758.5433); }
    
    float hash(vec2 uv){
        float a = amp(uv);
        #ifdef wave_thing
        float w = a>0.?(1.-.4*pow512(.51+.49*sin((.02*(uv.y+.5*uv.x)-jTime)*2.))):0.;
        #else
        float w=1.;
        #endif
        return (a>0.? a*pow1d5(hash21(uv))*w : 0.) - (textureMirror(iChannel0,vec2((uv.x*29.+uv.y)*.03125,1.)).x)*audio_vibration_amplitude;
    }

    float edgeMin(float dx,vec2 da, vec2 db,vec2 uv){
        uv.x+=5.;
        return min(min((1.-dx)*db.y, da.x), da.y);
    }

    vec2 trinoise(vec2 uv){
        uv *= uGridScale;
        const float sq = sqrt(3./2.);
        uv.x *= sq;
        uv.y -= .5*uv.x;
        vec2 d = fract(uv);
        uv -= d;
        bool c = dot(d,vec2(1))>1.;
        vec2 dd = 1.-d;
        vec2 da = c?dd:d,db = c?d:dd;
        float nn = hash(uv+float(c));
        float n2 = hash(uv+vec2(1,0));
        float n3 = hash(uv+vec2(0,1));
        float nmid = mix(n2,n3,d.y);
        float ns = mix(nn,c?n2:n3,da.y);
        float dx = da.x/db.y;
        return vec2(mix(ns,nmid,dx),edgeMin(dx,da, db,uv+d));
    }

    vec2 map(vec3 p){
        vec2 n = trinoise(p.xz);
        return vec2(p.y-uHeight*n.x,n.y);
    }

    vec3 grad(vec3 p){
        const vec2 e = vec2(.005,0);
        float a =map(p).x;
        return vec3(map(p+e.xyy).x-a ,map(p+e.yxy).x-a ,map(p+e.yyx).x-a)/e.x;
    }

    vec2 intersect(vec3 ro,vec3 rd){
        float d =0.,h=0.;
        for(int i = 0;i<120;i++){ 
            vec3 p = ro+d*rd;
            vec2 s = map(p);
            h = s.x;
            d+= h*.5;
            if(abs(h)<.003*d) return vec2(d,s.y);
            if(d>150.|| p.y > (uHeight + 20.0)) break; 
        }
        return vec2(-1);
    }

    void addsun(vec3 rd,vec3 ld,inout vec3 col){
        if(rd.y < 0.0) return;
        float sun = smoothstep(.21,.2,distance(rd,ld));
        if(sun>0.){
            float yd = (rd.y-ld.y);
            float a =sin(3.1*exp(-(yd)*14.)); 
            sun*=smoothstep(-.8,0.,a);
            col = mix(col, uSunColor, sun); 
        }
    }

    float starnoise(vec3 rd){
        float c = 0.;
        vec3 p = normalize(rd)*300.;
        for (float i=0.;i<4.;i++){
            vec3 q = fract(p)-.5;
            vec3 id = floor(p);
            float c2 = smoothstep(.5,0.,length(q));
            c2 *= step(hash21(id.xz/id.y), 0.12 - (uStarDensity * 0.1) - i*i*0.005);
            c += c2;
            p = p*.6+.5*p*mat3(3./5.,0,4./5.,0,1,0,-4./5.,0,3./5.);
        }
        c*=c;
        float g = dot(sin(rd*10.512),cos(rd.yzx*10.512));
        c*=smoothstep(-3.14,-.9,g)*.5+.5*smoothstep(-.3,1.,g);
        return c*c;
    }

    vec3 gsky(vec3 rd,vec3 ld,bool mask){
        float haze = exp2(-5.*(abs(rd.y)-.2*dot(rd,ld)));
        
        #ifdef stars_on
        float st = mask?(starnoise(rd))*(1.-min(haze,1.)):0.;
        #else
        float st = 0.;
        #endif
        
        float ang = atan(rd.x, rd.y - uSunY);
        float rays = textureMirror(iChannel0, vec2(ang * 1.5 / 3.14159 + iTime * 0.005, 0.0)).x;
        float dist = distance(vec2(rd.x, rd.y), vec2(0, uSunY));
        float rayMask = max(0., 1.0 - dist * (5.5 - uRayLength * 5.0)); 
        rayMask *= smoothstep(-0.1, 0.2, rd.y);
        
        vec3 beamCol = uSunColor * rays * rayMask * uRayStrength;
        vec3 back = uSkyColor * (1.0 - haze) + beamCol;
        
        #ifdef city
        float x = round(rd.x*30.);
        float h = hash21(vec2(x - uCitySeed));
        bool building = (h*h*.125*exp2(-x*x*x*x*.0025)>rd.y);
        if(mask && building) back*=0.,haze=.8, mask=mask && !building;
        #endif
        
        vec3 col=clamp(mix(back, uHorizonColor, haze)+st,0.,1.);
        if(mask)addsun(rd,ld,col);
        return col;  
    }

    void main() {
        vec2 fragCoord = gl_FragCoord.xy;
        fragColor=vec4(0);
        
        vec2 uv = (2.*fragCoord-iResolution.xy)/iResolution.y;
        float camX = uCamPos.x;
        float camY = uCamPos.y;

        const float shutter_speed = .25; 
        float dt = fract(hash21(fragCoord)+iTime)*shutter_speed;
        jTime = mod(iTime-dt*iTimeDelta,4000.);
        
        vec3 ro = vec3(camX * 10., 1.0 + camY * 5., (-20000.+jTime*speed));
        vec3 rd = normalize(vec3(uv, 4./3.));
        
        float rot = -camX * 0.5;
        mat2 rm = mat2(cos(rot), -sin(rot), sin(rot), cos(rot));
        rd.xz *= rm;

        vec2 i = intersect(ro,rd);
        float d = i.x;
        vec3 ld = normalize(vec3(0, uSunY +.05*sin(.1*jTime), 1));
        
        vec3 fog = d>0.?exp2(-d*vec3(0.04, 0.035, 0.05)):vec3(0.);
        vec3 sky = gsky(rd,ld,d<0.);
        vec3 p = ro+d*rd;
        vec3 n = normalize(grad(p));
        
        float diff = max(dot(n,ld), 0.0) + 0.3; 
        
        vec3 faceColor = uGridColor * 0.2; 
        vec3 lineColor = uGridColor * 1.5; 
        float gridMask = smoothstep(uLineWidth, 0.0, i.y);
        vec3 col = mix(faceColor, lineColor, gridMask);
        
        col *= diff;
        
        vec3 rfd = reflect(rd,n); 
        vec3 rfcol = gsky(rfd,ld,true);
        float fresnel = .05 + .95 * pow(max(1.+dot(rd,n),0.),5.);
        fresnel = min(fresnel, uReflection); 
        
        col = mix(col,rfcol,fresnel);
        col = mix(sky, col, fog);
        
        if(d<0.) d=1e6;
        d=min(d,10.);
        fragColor += vec4(clamp(col,0.,1.),d<0.?0.:.1+exp2(-d));
        fragColor.a = 1.0;
    }`;

    return header + defines + core;
}

/** * WEBGL SYSTEM */
function initGL() {
    gl = canvas.getContext('webgl2', { alpha: false, preserveDrawingBuffer: true });
    if (!gl) { alert("WebGL2 not supported"); return; }
    
    const size = 256;
    const data = new Uint8Array(size * size * 4);
    for(let i=0; i<data.length; i++) data[i] = Math.random() * 255;
    noiseTexture = gl.createTexture();
    gl.bindTexture(gl.TEXTURE_2D, noiseTexture);
    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, size, size, 0, gl.RGBA, gl.UNSIGNED_BYTE, data);
    gl.generateMipmap(gl.TEXTURE_2D);

    compileShader();
    
    const buf = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, buf);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1, -1, 3, -1, -1, 3]), gl.STATIC_DRAW);
    
    requestAnimationFrame(loop);
}

function compileShader() {
    const vs = gl.createShader(gl.VERTEX_SHADER);
    gl.shaderSource(vs, vsSource);
    gl.compileShader(vs);

    const fs = gl.createShader(gl.FRAGMENT_SHADER);
    gl.shaderSource(fs, getFsSource());
    gl.compileShader(fs);
    
    if (!gl.getShaderParameter(fs, gl.COMPILE_STATUS)) {
        console.error(gl.getShaderInfoLog(fs));
        return;
    }

    if (program) gl.deleteProgram(program);
    program = gl.createProgram();
    gl.attachShader(program, vs);
    gl.attachShader(program, fs);
    gl.linkProgram(program);
    gl.useProgram(program);
}

function loop() {
    const time = (Date.now() - startTime) / 1000;
    
    if (canvas.width !== canvas.clientWidth || canvas.height !== canvas.clientHeight) {
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;
        gl.viewport(0, 0, canvas.width, canvas.height);
    }

    if(program) {
        gl.useProgram(program);
        
        const posLoc = gl.getAttribLocation(program, 'position');
        gl.enableVertexAttribArray(posLoc);
        gl.vertexAttribPointer(posLoc, 2, gl.FLOAT, false, 0, 0);

        gl.uniform3f(gl.getUniformLocation(program, "iResolution"), canvas.width, canvas.height, 1);
        gl.uniform1f(gl.getUniformLocation(program, "iTime"), time);
        gl.uniform1f(gl.getUniformLocation(program, "iTimeDelta"), 1.0/60.0);
        gl.uniform1f(gl.getUniformLocation(program, "uSpeed"), state.speed);
        gl.uniform1f(gl.getUniformLocation(program, "uHeight"), state.height);
        gl.uniform2f(gl.getUniformLocation(program, "uCamPos"), camera.x, camera.y);
        
        gl.uniform1f(gl.getUniformLocation(program, "uGridScale"), state.gridScale);
        gl.uniform1f(gl.getUniformLocation(program, "uLineWidth"), state.lineWidth);
        gl.uniform1f(gl.getUniformLocation(program, "uReflection"), state.reflection);
        gl.uniform1f(gl.getUniformLocation(program, "uSunY"), state.sunY);
        gl.uniform1f(gl.getUniformLocation(program, "uRayLength"), state.rayLength);
        gl.uniform1f(gl.getUniformLocation(program, "uRayStrength"), state.rayStrength);
        gl.uniform1f(gl.getUniformLocation(program, "uCitySeed"), state.citySeed);
        gl.uniform1f(gl.getUniformLocation(program, "uStarDensity"), state.starDensity);

        const sky = hexToRGB(state.skyColor);
        gl.uniform3f(gl.getUniformLocation(program, "uSkyColor"), sky[0], sky[1], sky[2]);
        const horizon = hexToRGB(state.horizonColor);
        gl.uniform3f(gl.getUniformLocation(program, "uHorizonColor"), horizon[0], horizon[1], horizon[2]);
        const grid = hexToRGB(state.gridColor);
        gl.uniform3f(gl.getUniformLocation(program, "uGridColor"), grid[0], grid[1], grid[2]);
        const sun = hexToRGB(state.sunColor);
        gl.uniform3f(gl.getUniformLocation(program, "uSunColor"), sun[0], sun[1], sun[2]);
        
        gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D, noiseTexture);
        gl.uniform1i(gl.getUniformLocation(program, "iChannel0"), 0);

        gl.drawArrays(gl.TRIANGLES, 0, 3);
    }
    requestAnimationFrame(loop);
}

/** * UI LOGIC */
function updateUI() {
    // Toggles styling
    document.getElementById('btn-city').className = state.city ? 'toggle-btn active' : 'toggle-btn';
    document.getElementById('btn-wave').className = state.wave ? 'toggle-btn active' : 'toggle-btn';
    document.getElementById('btn-stars').className = state.stars ? 'toggle-btn active' : 'toggle-btn';

    document.getElementById('speed-range').value = state.speed;
    document.getElementById('height-range').value = state.height;
    document.getElementById('scale-range').value = state.gridScale;
    document.getElementById('line-width-range').value = state.lineWidth;
    document.getElementById('reflect-range').value = state.reflection;
    document.getElementById('ray-len-range').value = state.rayLength;
    document.getElementById('ray-str-range').value = state.rayStrength;
    document.getElementById('stars-range').value = state.starDensity;
    document.getElementById('auto-check').checked = !!autoTimer;
    
    document.getElementById('sky-color').value = state.skyColor;
    document.getElementById('horizon-color').value = state.horizonColor;
    document.getElementById('grid-color').value = state.gridColor;
    document.getElementById('sun-color').value = state.sunColor;

    document.getElementById('speed-val').innerText = state.speed.toFixed(1);
    document.getElementById('height-val').innerText = state.height.toFixed(1);
    document.getElementById('scale-val').innerText = state.gridScale.toFixed(2);
    document.getElementById('line-width-val').innerText = state.lineWidth.toFixed(2);
    document.getElementById('reflect-val').innerText = state.reflection.toFixed(2);
    document.getElementById('ray-len-val').innerText = state.rayLength.toFixed(2);
    document.getElementById('ray-str-val').innerText = state.rayStrength.toFixed(2);
    document.getElementById('stars-val').innerText = state.starDensity.toFixed(1);
}

function setVal(key, val, recompile = false) {
    if (recompile) {
        fader.style.opacity = 1;
        setTimeout(() => {
            state[key] = val;
            updateUI();
            compileShader();
            setTimeout(() => fader.style.opacity = 0, 100);
        }, 300);
    } else {
        state[key] = val;
        updateUI();
    }
}

function randColor() {
    const r = Math.floor(Math.random() * 255);
    const g = Math.floor(Math.random() * 255);
    const b = Math.floor(Math.random() * 255);
    return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
}

function randomize() {
    fader.style.opacity = 1;
    setTimeout(() => {
        const r = Math.random;
        state.speed = r() * 12 + 1;
        state.height = r() * 3.5 + 0.5;
        state.gridScale = 0.5 + r() * 0.5; 
        state.lineWidth = 0.02 + r() * 0.05; 
        state.reflection = 0.2 + r() * 0.7;
        state.sunY = 0.125; 
        state.citySeed = r() * 200.0; 
        state.starDensity = 0.1 + r() * 0.9; 
        state.rayLength = 0.3 + r() * 0.7;
        state.rayStrength = 0.3 + r() * 0.7;
        state.city = r() > 0.6;
        state.wave = r() > 0.4;
        state.stars = true;
        
        if (r() > 0.3) {
            state.skyColor = randColor();
            state.horizonColor = randColor();
            state.gridColor = randColor();
            state.sunColor = hslToHex(r() * 360, 70 + r() * 30, 60 + r() * 30);
        } else {
            state.skyColor = "#441155";
            state.horizonColor = "#bd20a4";
            state.gridColor = "#110022";
            state.sunColor = "#FFCC00";
        }

        camera = { x: 0, y: 0 };
        updateUI();
        compileShader();
        setTimeout(() => fader.style.opacity = 0, 100);
    }, 450);
}

/** * EVENT HANDLERS */
window.onload = () => {
    initGL();
    
    // Toggle Buttons
    document.getElementById('btn-city').onclick = () => setVal('city', !state.city, true);
    document.getElementById('btn-wave').onclick = () => setVal('wave', !state.wave, true);
    document.getElementById('btn-stars').onclick = () => setVal('stars', !state.stars, true);
    
    // Sliders
    document.getElementById('speed-range').oninput = (e) => setVal('speed', parseFloat(e.target.value));
    document.getElementById('height-range').oninput = (e) => setVal('height', parseFloat(e.target.value));
    document.getElementById('scale-range').oninput = (e) => setVal('gridScale', parseFloat(e.target.value));
    document.getElementById('line-width-range').oninput = (e) => setVal('lineWidth', parseFloat(e.target.value));
    document.getElementById('reflect-range').oninput = (e) => setVal('reflection', parseFloat(e.target.value));
    document.getElementById('ray-len-range').oninput = (e) => setVal('rayLength', parseFloat(e.target.value));
    document.getElementById('ray-str-range').oninput = (e) => setVal('rayStrength', parseFloat(e.target.value));
    document.getElementById('stars-range').oninput = (e) => setVal('starDensity', parseFloat(e.target.value));

    // Colors
    document.getElementById('sky-color').oninput = (e) => setVal('skyColor', e.target.value);
    document.getElementById('horizon-color').oninput = (e) => setVal('horizonColor', e.target.value);
    document.getElementById('grid-color').oninput = (e) => setVal('gridColor', e.target.value);
    document.getElementById('sun-color').oninput = (e) => setVal('sunColor', e.target.value);
    
    document.getElementById('random-btn').onclick = randomize;
    document.getElementById('reset-btn').onclick = () => { 
        fader.style.opacity = 1;
        setTimeout(() => {
            state = {...defaults}; 
            camera = {x:0,y:0}; 
            updateUI(); 
            compileShader();
            setTimeout(() => fader.style.opacity = 0, 100);
        }, 300);
    };
    
    document.getElementById('auto-check').onchange = (e) => {
        if(e.target.checked) {
            autoTimer = setInterval(randomize, 10000);
        } else {
            clearInterval(autoTimer);
            autoTimer = null;
        }
    };

    // Menu System
    const menuBtn = document.getElementById('menu-btn');
    const panel = document.getElementById('settings-panel');
    const closeBtn = document.getElementById('close-btn');
    const infoBtn = document.getElementById('info-btn');

    function toggleMenu(forceClose) {
        if (forceClose === true) isMenuOpen = false;
        else isMenuOpen = !isMenuOpen;

        if (isMenuOpen) {
            panel.classList.add('active');
            menuBtn.classList.add('open');
            menuBtn.style.opacity = 0; 
        } else {
            panel.classList.remove('active');
            menuBtn.classList.remove('open');
            menuBtn.style.opacity = 1;
        }
    }

    menuBtn.onclick = (e) => { e.stopPropagation(); toggleMenu(); };
    closeBtn.onclick = () => toggleMenu(true);

    const modal = document.getElementById('info-modal');
    infoBtn.onclick = () => modal.classList.add('visible');
    document.getElementById('modal-close').onclick = () => modal.classList.remove('visible');
    
    // Updated ESC Key Logic
    window.onkeydown = (e) => {
        if(e.key === "Escape") {
            if (modal.classList.contains('visible')) {
                modal.classList.remove('visible');
            } else if (isMenuOpen) {
                toggleMenu(true);
            }
        }
    };

    // Export/Import
    document.getElementById('export-btn').onclick = () => {
        const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
        const el = document.createElement('a');
        el.href = data;
        el.download = `CyberHorizon_${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.json`;
        el.click();
    };

    document.getElementById('import-btn-trigger').onclick = () => document.getElementById('import-file').click();
    document.getElementById('import-file').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                fader.style.opacity = 1;
                setTimeout(() => {
                    state = JSON.parse(ev.target.result);
                    updateUI();
                    compileShader();
                    setTimeout(() => fader.style.opacity = 0, 100);
                }, 300);
            } catch(x) { alert("Invalid Settings File"); }
        };
        reader.readAsText(e.target.files[0]);
    };

    // 4K Wallpaper
    document.getElementById('shot-btn').onclick = () => {
        const w = canvas.width; const h = canvas.height;
        canvas.width = 3840; canvas.height = 2160;
        gl.viewport(0,0,3840,2160);
        if(program) {
            gl.useProgram(program);
            gl.uniform3f(gl.getUniformLocation(program, "iResolution"), 3840, 2160, 1);
            gl.drawArrays(gl.TRIANGLES, 0, 3);
        }
        canvas.toBlob((blob) => {
            const el = document.createElement('a');
            el.href = URL.createObjectURL(blob);
            el.download = "CyberHorizon_4K.png";
            el.click();
            canvas.width = w; canvas.height = h;
            gl.viewport(0,0,w,h);
        });
    };

    /** * UNIFIED POINTER SYSTEM */
    let pointers = new Map();
    let didMove = false;
    let lastTap = 0;

    canvas.onpointerdown = (e) => {
        pointers.set(e.pointerId, e);
        if (isMenuOpen) {
            wasMenuOpenOnDown = true;
            if (e.clientX > 340) toggleMenu(true); 
        } else {
            wasMenuOpenOnDown = false;
        }
        didMove = false;
    };

    canvas.onpointermove = (e) => {
        if (!pointers.has(e.pointerId)) return;
        
        if (pointers.size === 1) {
            const prev = pointers.get(e.pointerId);
            const dx = e.clientX - prev.clientX;
            const dy = e.clientY - prev.clientY;
            
            if (Math.abs(dx) > 2 || Math.abs(dy) > 2) didMove = true;
            // Panning Disabled
            // camera.x += dx * 0.001;
            // camera.y += dy * 0.001;
        }
        pointers.set(e.pointerId, e);
    };

    canvas.onpointerup = (e) => {
        pointers.delete(e.pointerId);
        if (!didMove && !wasMenuOpenOnDown) {
            const now = Date.now();
            if (e.pointerType === 'touch') {
                if (now - lastTap < 300) randomize();
                lastTap = now;
            } else {
                if (!isMenuOpen) randomize();
            }
        }
    };
    
    // Initialize UI State
    updateUI();
};
</script>
</body>
</html>